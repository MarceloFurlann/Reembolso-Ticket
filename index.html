<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saldo de Reembolso</title>
    <style>
        body { font-family: "Century Gothic", Arial, sans-serif; margin: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { height: 60px; }
        h2 { margin: 0; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
    </style>
</head>
<body>
    <header>
        <h2>Saldo de Reembolso</h2>
        <img class="logo" src="https://cdn.cookielaw.org/logos/3eee82c0-9eb6-4614-b723-8d597fdcce8d/01990669-53ca-7e07-b027-a305e1e7b1f6/e7e9a2f5-d961-403e-a109-033228694c0e/Ticket-Edenred-Logo-Color-RGB111_(2).png" alt="Logo Edenred">
    </header>

    <h3>Tabela Consolidada</h3>
    <table id="tabelaConsolidada">
        <thead>
            <tr>
                <th>Card</th>
                <th>GN</th>
                <th>Grupo</th>
                <th>Status do Card</th>
                <th>Produto</th>
                <th>Data Início</th>
                <th>Data Fim</th>
                <th>Saldo</th>
                <th>Baixas</th>
                <th>Saldo Final</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        async function montarTabelaConsolidada() {
            const urlPrincipal = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOZDNQn8PUWZrAWjXX0W31mDgHWubFfxF9pTKRPOAZcGIuf-M4pOik8Kt6Kj3uEJD8zes1SMQP3ez/pub?gid=1498775002&single=true&output=csv";
            const urlBaixas = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuI00U9cr-4BjVPW-AQuobUe6VXH-c-aUtEsbK5FLS2z4OGX8Ek363KMCUeywpfX3J_wYkA4bfY7be/pub?gid=1665327090&single=true&output=csv";

            const [dadosPrincipal, dadosBaixas] = await Promise.all([
                fetch(urlPrincipal).then(r => r.text()),
                fetch(urlBaixas).then(r => r.text())
            ]);

            processarTabela(dadosPrincipal, dadosBaixas);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(value) {
            if (!value || value.trim() === "") return "";
            const clean = value.replace(/[^0-9]/g, "");
            if (clean.length === 8) {
                return `${clean.slice(0,2)}/${clean.slice(2,4)}/${clean.slice(4)}`;
            }
            return value;
        }

        function processarTabela(csvPrincipal, csvBaixas) {
            const linhasPrincipal = csvPrincipal.split("\n").map(l => l.split(","));
            const linhasBaixas = csvBaixas.split("\n").map(l => l.split(","));

            const headerPrincipal = linhasPrincipal[0].map(h => h.trim().toLowerCase());
            const idxCard = headerPrincipal.indexOf("card");
            const idxGN = headerPrincipal.indexOf("gn");
            const idxGrupo = headerPrincipal.indexOf("grupo");
            const idxStatus = headerPrincipal.indexOf("status");
            const idxProduto = headerPrincipal.indexOf("produto");
            const idxDataInicio = headerPrincipal.indexOf("data início");
            const idxDataFim = headerPrincipal.indexOf("data fim");
            const idxSaldo = headerPrincipal.indexOf("saldo");

            const headerBaixas = linhasBaixas[0].map(h => h.trim().toLowerCase());
            const idxCardBaixas = headerBaixas.indexOf("card");
            const idxValorBaixa = headerBaixas.indexOf("valor baixa");

            const agrupado = {};

            for (let i = 1; i < linhasPrincipal.length; i++) {
                const linha = linhasPrincipal[i];
                const card = linha[idxCard]?.trim();
                if (!card) continue;

                if (!agrupado[card]) {
                    agrupado[card] = {
                        card,
                        gn: linha[idxGN] || "",
                        grupo: linha[idxGrupo] || "",
                        status: linha[idxStatus] || "",
                        produto: linha[idxProduto] || "",
                        dataInicio: formatDate(linha[idxDataInicio] || ""),
                        dataFim: formatDate(linha[idxDataFim] || ""),
                        saldo: 0,
                        baixas: 0
                    };
                }
                agrupado[card].saldo += parseFloat(linha[idxSaldo]?.replace(",", ".") || 0);
            }

            for (let i = 1; i < linhasBaixas.length; i++) {
                const linha = linhasBaixas[i];
                const card = linha[idxCardBaixas]?.trim();
                const valor = parseFloat(linha[idxValorBaixa]?.replace(",", ".") || 0);
                if (agrupado[card]) {
                    agrupado[card].baixas += valor;
                }
            }

            Object.values(agrupado).forEach(item => {
                item.saldoFinal = item.saldo - item.baixas;
            });

            renderTabelaConsolidada(Object.values(agrupado));
        }

        function renderTabelaConsolidada(dados) {
            const tbody = document.querySelector("#tabelaConsolidada tbody");
            tbody.innerHTML = "";

            dados.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.card}</td>
                        <td>${item.gn}</td>
                        <td>${item.grupo}</td>
                        <td>${item.status}</td>
                        <td>${item.produto}</td>
                        <td>${item.dataInicio}</td>
                        <td>${item.dataFim}</td>
                        <td>${formatCurrency(item.saldo)}</td>
                        <td>${formatCurrency(item.baixas)}</td>
                        <td>${formatCurrency(item.saldoFinal)}</td>
                    </tr>
                `;
            });
        }

        montarTabelaConsolidada();
    </script>
</body>
</html>
